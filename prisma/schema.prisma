generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum UserRole {
  ADMINISTRADOR
  GERENTE
  FUNCIONARIO
}

enum StockEntryType {
  COMPRA      // entrada real com custo (impacta lucro)
  AJUSTE      // corre칞칚o positiva (neutro)
  DEVOLUCAO   // devolu칞칚o de cliente (neutro)
}

enum StockExitType {
  VENDA       // gera receita
  AJUSTE      // corre칞칚o negativa (neutro)
  PERDA       // preju칤zo
  VENCIMENTO  // preju칤zo
}

//////////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////////

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      UserRole @default(FUNCIONARIO)
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Produtos
  createdProducts Product[] @relation("produtosCriados")
  updatedProducts Product[] @relation("produtosAtualizados")

  // 游댮 ALTERA칂츾O IMPORTANTE
  // Relacionamento com movimenta칞칫es de estoque
  // Necess치rio para relat칩rios por vendedor
  stockEntries StockEntry[]
  stockExits   StockExit[]

  @@map("usuarios")
}

//////////////////////////////////////////////////////
// PRODUCT
//////////////////////////////////////////////////////

model Product {
  id     String @id @default(cuid())
  name   String
  status Boolean @default(true)
  volume String

  unitPrice Decimal @db.Decimal(10, 2)


  // =========================
  // ESTOQUE ATUAL (CACHE)
  // =========================
  // 丘멆잺 Esses campos S칍 DEVEM ser alterados via
  // StockEntry / StockExit (transa칞칚o)
  unitsInStock   Int @default(0)
 

  minunitsInStock  Int @default(0)


  availableUnit   Boolean @default(true)
  availableBox    Boolean @default(false)
  availableBundle Boolean @default(false)
  availableOther  Boolean @default(false)

  unitsPerBox    Int?
  unitsPerBundle Int?
  unitsPerOther  Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  categoryId  String?
  createdById String
  updatedById String?

  category  Category? @relation(fields: [categoryId], references: [id])
  createdBy User      @relation("produtosCriados", fields: [createdById], references: [id])
  updatedBy User?     @relation("produtosAtualizados", fields: [updatedById], references: [id])

  barcodes ProductBarcode[]

  // 游댮 CAMPOS QUE FALTAVAM
  stockEntryItems StockEntryItem[]
  stockExitItems  StockExitItem[]

  @@map("produtos")
}


//////////////////////////////////////////////////////
// PRODUCT BARCODE
//////////////////////////////////////////////////////

model ProductBarcode {
  id        String @id @default(cuid())
  barcode   String @unique

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////////
// CATEGORY
//////////////////////////////////////////////////////

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@map("categorias")
}

//////////////////////////////////////////////////////
// STOCK ENTRY (ENTRADA)
//////////////////////////////////////////////////////

model StockEntry {
  id   String @id @default(cuid())

  // COMPRA / AJUSTE / DEVOLUCAO
  type StockEntryType @default(COMPRA)

  notes String?

  createdAt DateTime @default(now())

  // 游댮 ALTERA칂츾O IMPORTANTE
  // 칈ndice para relat칩rio por per칤odo
  @@index([createdAt])

  createdById String
  createdBy   User @relation(fields: [createdById], references: [id])

  items StockEntryItem[]

  @@map("estoque_entradas")
}

model StockEntryItem {
  id            String     @id @default(cuid())

  stockEntryId  String
  stockEntry    StockEntry @relation(fields: [stockEntryId], references: [id])

  productId     String
  product       Product    @relation(fields: [productId], references: [id])

  quantity      Int
  unitCost      Decimal?   @db.Decimal(10, 2)

  lotNumber     String?
  expiresAt     DateTime?  // 拘勇 ESTE CAMPO N츾O EXISTE HOJE NO SEU SCHEMA

  createdAt     DateTime   @default(now())
}


//////////////////////////////////////////////////////
// STOCK EXIT (SA칈DA)
//////////////////////////////////////////////////////

model StockExit {
  id String @id @default(cuid())

  // VENDA / PERDA / VENCIMENTO / AJUSTE
  type StockExitType @default(VENDA)

  notes String?

  createdAt DateTime @default(now())

  // 游댮 ALTERA칂츾O IMPORTANTE
  // 칈ndice para relat칩rio
  @@index([createdAt])

  createdById String
  createdBy   User @relation(fields: [createdById], references: [id])

  items StockExitItem[]

  @@map("estoque_saidas")
}

model StockExitItem {
  id String @id @default(cuid())

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Int

  // Pre칞o usado na sa칤da
  // obrigat칩rio se type = VENDA
  unitPrice Decimal? @db.Decimal(10, 2)

  exitId String
  exit   StockExit @relation(fields: [exitId], references: [id], onDelete: Cascade)

  @@map("estoque_saida_itens")
}
